// ***************************************************************************
// Copyright (c) 2017, Industrial Logic, Inc., All Rights Reserved.
//
// This code is the exclusive property of Industrial Logic, Inc. It may ONLY be
// used by students during Industrial Logic's workshops or by individuals
// who are being coached by Industrial Logic on a project.
//
// This code may NOT be copied or used for any other purpose without the prior
// written consent of Industrial Logic, Inc.
// ****************************************************************************

var log = require('../logger').create('launcher')

/**
 * Kill browser if it does not capture in given `captureTimeout`.
 */
var CaptureTimeoutLauncher = function (timer, captureTimeout) {
  if (!captureTimeout) {
    return
  }

  var self = this
  var pendingTimeoutId = null

  this.on('start', function () {
    pendingTimeoutId = timer.setTimeout(function () {
      pendingTimeoutId = null
      if (self.state !== self.STATE_BEING_CAPTURED) {
        return
      }

      log.warn('%s have not captured in %d ms, killing.', self.name, captureTimeout)
      self.error = 'timeout'
      self.kill()
    }, captureTimeout)
  })

  this.on('done', function () {
    if (pendingTimeoutId) {
      timer.clearTimeout(pendingTimeoutId)
      pendingTimeoutId = null
    }
  })
}

CaptureTimeoutLauncher.decoratorFactory = function (timer,
  /* config.captureTimeout */ captureTimeout) {
  return function (launcher) {
    CaptureTimeoutLauncher.call(launcher, timer, captureTimeout)
  }
}

CaptureTimeoutLauncher.decoratorFactory.$inject = ['timer', 'config.captureTimeout']

module.exports = CaptureTimeoutLauncher
