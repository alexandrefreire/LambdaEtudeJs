// ***************************************************************************
// Copyright (c) 2017, Industrial Logic, Inc., All Rights Reserved.
//
// This code is the exclusive property of Industrial Logic, Inc. It may ONLY be
// used by students during Industrial Logic's workshops or by individuals
// who are being coached by Industrial Logic on a project.
//
// This code may NOT be copied or used for any other purpose without the prior
// written consent of Industrial Logic, Inc.
// ****************************************************************************

"use strict";
var vows = require('vows')
, assert = require('assert')
, path = require('path')
, sandbox = require('sandboxed-module');

vows.describe('log4js-abspath').addBatch({
  'options': {
    topic: function() {
      var appenderOptions,
      log4js = sandbox.require(
        '../lib/log4js',
        { requires:
          { './appenders/fake':
            { name: "fake",
              appender: function() {},
              configure: function(configuration, options) {
                appenderOptions = options;
                return function() {};
              }
            }
          }
        }
      ),
      config = {
        "appenders": [
          {
            "type" : "fake",
            "filename" : "cheesy-wotsits.log"
          }
        ]
      };
      
      log4js.configure(config, {
        cwd: '/absolute/path/to'
      });
      return appenderOptions;
    },
    'should be passed to appenders during configuration': function(options) {
      assert.equal(options.cwd, '/absolute/path/to');
    }
  },

  'file appender': {
    topic: function() {
      var fileOpened,
      fileAppender = sandbox.require(
        '../lib/appenders/file',
        { requires:
          { '../streams':
            { RollingFileStream: 
              function(file) {
                fileOpened = file;
                return {
                  on: function() {},
                  end: function() {}
                };
              }
            }
          }
        }
      );
      fileAppender.configure(
        { 
          filename: "whatever.log", 
          maxLogSize: 10 
        }, 
        { cwd: '/absolute/path/to' }
      );
      return fileOpened;
    },
    'should prepend options.cwd to config.filename': function(fileOpened) {
      var expected = path.sep + path.join("absolute", "path", "to", "whatever.log");
      assert.equal(fileOpened, expected);
    }
  },
}).export(module);
